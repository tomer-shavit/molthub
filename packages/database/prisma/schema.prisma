generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Workspace {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  awsAccountId String?
  awsRegion    String   @default("us-east-1")

  users                 User[]
  botInstances          BotInstance[]
  fleets                Fleet[]
  templates             Template[]
  profiles              Profile[]
  overlays              Overlay[]
  policyPacks           PolicyPack[]
  integrationConnectors IntegrationConnector[]
  auditEvents           AuditEvent[]
  skillPacks            SkillPack[]
  communicationChannels CommunicationChannel[]
  notificationChannels  NotificationChannel[]
  botRoutingRules       BotRoutingRule[]
  botTeamMembers        BotTeamMember[]
  alertRuleConfigs      AlertRuleConfig[]

  @@index([slug])
}

model User {
  id          String    @id @default(cuid())
  email       String
  name        String
  role        String  @default("VIEWER")
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  auditEvents AuditEvent[]

  @@unique([email, workspaceId])
}

// Fleet: Grouping concept for environments
model Fleet {
  id          String      @id @default(cuid())
  name        String
  workspaceId String
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  environment String
  description String?
  status      String @default("ACTIVE")
  tags        String        @default("{}")

  // Configuration
  defaultProfileId      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  instances BotInstance[]
  profiles  Profile[]

  // Phase 2 relations
  budgetConfigs BudgetConfig[]
  healthAlerts  HealthAlert[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([status])
}
// Enhanced BotInstance with fleet association
model BotInstance {
  id          String    @id @default(cuid())
  name        String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  fleetId     String
  fleet       Fleet     @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  // Configuration layers
  templateId String?
  profileId  String?
  overlayIds String    @default("[]")

  // Current state
  status                 String @default("CREATING")
  health                 String @default("UNKNOWN")
  desiredManifest        String
  appliedManifestVersion String?

  // Operational metadata
  tags     String @default("{}")
  metadata String @default("{}")

  // Runtime info
  lastReconcileAt   DateTime?
  lastHealthCheckAt DateTime?
  lastError         String?
  errorCount        Int       @default(0)

  // Health metrics
  restartCount  Int       @default(0)
  runningSince  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // OpenClaw-native fields
  deploymentType     String?
  deploymentTargetId String?
  deploymentTarget   DeploymentTarget? @relation(fields: [deploymentTargetId], references: [id])
  gatewayPort        Int?
  profileName        String?
  openclawVersion     String?
  configHash         String?
  lastCostSyncDate   String?

  // AI Gateway settings
  aiGatewayEnabled  Boolean @default(false)
  aiGatewayUrl      String?
  aiGatewayApiKey   String?
  aiGatewayProvider String  @default("vercel-ai-gateway")

  // Relations
  connectorBindings   BotConnectorBinding[]
  changeSets          ChangeSet[]
  traces              Trace[]
  skillPacks          BotInstanceSkillPack[]
  channelBindings     BotChannelBinding[]
  gatewayConnection   GatewayConnection?
  openclawProfile      OpenClawProfile?
  channelAuthSessions ChannelAuthSession[]
  healthSnapshots     HealthSnapshot[]
  agentStateSnapshots AgentStateSnapshot[]
  securityAudits      SecurityAuditResult[]
  devicePairings      DevicePairing[]

  // Phase 2 relations
  sloDefinitions SloDefinition[]
  budgetConfigs  BudgetConfig[]
  costEvents     CostEvent[]
  healthAlerts   HealthAlert[]

  // Routing rules
  routingRulesAsSource BotRoutingRule[] @relation("SourceBot")
  routingRulesAsTarget BotRoutingRule[] @relation("TargetBot")

  // A2A API keys
  a2aApiKeys A2aApiKey[]

  // Team relationships
  teamMembers    BotTeamMember[] @relation("TeamOwner")
  memberOfTeams  BotTeamMember[] @relation("TeamMember")

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([fleetId])
  @@index([status])
  @@index([health])
}


// Profile: Shared defaults for instances
model Profile {
  id          String    @id @default(cuid())
  name        String
  description String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Scope
  fleetIds String @default("[]") // Empty = available to all fleets

  // Default configurations
  defaults      String // Profile defaults object
  mergeStrategy String @default("{}")

  // Override settings
  allowInstanceOverrides Boolean @default(true)
  lockedFields           String    @default("[]")

  // Priority for applying multiple profiles
  priority Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  fleets Fleet[]

  @@index([workspaceId])
  @@index([isActive])
}

// Overlay: Per-bot configuration overrides
model Overlay {
  id          String    @id @default(cuid())
  name        String
  description String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Target specification
  targetType     String // instance, fleet, environment, tag
  targetSelector String // Selector criteria

  // Override values
  overrides String // Override configuration

  // Behavior
  priority Int     @default(0)
  enabled  Boolean @default(true)
  rollout  String? // Rollout configuration
  schedule String? // Schedule for temporary overlays

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([workspaceId])
  @@index([enabled])
  @@index([targetType])
}

// PolicyPack: Enforced rules
model PolicyPack {
  id          String     @id @default(cuid())
  name        String
  description String
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  // Scope
  isBuiltin          Boolean @default(false)
  autoApply          Boolean @default(false)
  targetWorkspaces   String?
  targetEnvironments String?
  targetTags         String?

  // Rules
  rules String // Array of PolicyRule objects

  // Settings
  isEnforced Boolean @default(false)
  priority   Int     @default(0)
  version    String  @default("1.0.0")
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([workspaceId])
  @@index([isBuiltin])
  @@index([isActive])
  @@index([autoApply])
}

// IntegrationConnector: Shared credentials
model IntegrationConnector {
  id          String    @id @default(cuid())
  name        String
  description String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Type and configuration
  type   String // openai, slack, discord, etc.
  config String // ConnectionConfig object

  // Status
  status         String @default("PENDING")
  statusMessage  String?
  lastTestedAt   DateTime?
  lastTestResult String?
  lastError      String?

  // Sharing
  isShared           Boolean @default(true)
  allowedInstanceIds String? // If not shared, specific instances

  // Rotation
  rotationSchedule String?

  // Usage tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  tags String @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  botBindings BotConnectorBinding[]

  @@index([workspaceId])
  @@index([type])
  @@index([status])
}
// Bot to Connector binding
model BotConnectorBinding {
  id            String               @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance          @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  connectorId   String
  connector     IntegrationConnector @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  purpose       String // llm, channel, database, etc.
  channelConfig String? // Channel-specific configuration
  overrides     String? // Bot-specific overrides

  healthStatus    String    @default("UNKNOWN")
  lastHealthCheck DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([botInstanceId, connectorId, purpose])
  @@index([botInstanceId])
  @@index([connectorId])
}

// ChangeSet: Track configuration changes
model ChangeSet {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)

  changeType  String // UPDATE, ROLLOUT, ROLLBACK
  description String

  // Change details
  fromManifest String?
  toManifest   String

  // Rollout configuration
  rolloutStrategy   String @default("ALL") // ALL, PERCENTAGE, CANARY
  rolloutPercentage Int?
  canaryInstances   String?

  // Status
  status String @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED, ROLLED_BACK

  // Progress tracking
  totalInstances   Int @default(0)
  updatedInstances Int @default(0)
  failedInstances  Int @default(0)

  startedAt   DateTime?
  completedAt DateTime?

  // Rollback info
  canRollback  Boolean   @default(false)
  rolledBackAt DateTime?
  rolledBackBy String?

  createdAt DateTime @default(now())
  createdBy String

  // Relations
  auditEvents AuditEvent[]

  @@index([botInstanceId])
  @@index([status])
  @@index([createdAt])
}

// Trace: Execution traces
model Trace {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)

  traceId       String  @unique // External trace ID
  parentTraceId String?

  // Trace metadata
  name   String
  type   String // REQUEST, TASK, SKILL, etc.
  status String // SUCCESS, ERROR, PENDING

  // Timing
  startedAt  DateTime
  endedAt    DateTime?
  durationMs Int?

  // Details
  input  String?
  output String?
  error  String?

  // Context
  metadata String @default("{}")
  tags     String @default("{}")

  createdAt DateTime @default(now())

  @@index([botInstanceId])
  @@index([traceId])
  @@index([startedAt])
  @@index([status])
}

model AuditEvent {
  id           String    @id @default(cuid())
  actor        String
  user         User      @relation(fields: [actor], references: [id])
  action       String
  resourceType String
  resourceId   String
  diffSummary  String?
  metadata     String      @default("{}")
  timestamp    DateTime  @default(now())
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Optional relations
  changeSetId String?
  changeSet   ChangeSet? @relation(fields: [changeSetId], references: [id])

  @@index([workspaceId])
  @@index([resourceType, resourceId])
  @@index([timestamp])
  @@index([changeSetId])
}

model Template {
  id               String     @id @default(cuid())
  name             String
  description      String
  category         String
  manifestTemplate String
  isBuiltin        Boolean    @default(false)
  workspaceId      String?
  workspace        Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([workspaceId])
  @@index([category])
}


// SkillPack: Reusable bundle of skills and MCPs for multiple bots
model SkillPack {
  id          String   @id @default(cuid())
  name        String
  description String?
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Skills configuration (e.g., [{"name": "github", "version": "1.0.0"}])
  skills String @default("[]")
  
  // MCP servers configuration
  // e.g., [{"name": "github", "command": "npx -y @modelcontextprotocol/server-github"}]
  mcps String @default("[]")
  
  // String variables shared across all bots using this pack
  envVars String @default("{}")
  
  // Whether this is a built-in pack (provided by Clawster)
  isBuiltin Boolean @default(false)
  
  // Version for tracking changes
  version Int @default(1)
  
  // Relations
  botInstances BotInstanceSkillPack[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  
  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([isBuiltin])
}

// Junction table for BotInstance <-> SkillPack many-to-many relation
model BotInstanceSkillPack {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  skillPackId   String
  skillPack     SkillPack   @relation(fields: [skillPackId], references: [id], onDelete: Cascade)

  // Instance-specific overrides (merged with pack defaults)
  envOverrides String @default("{}")

  // When this pack was attached to the bot
  attachedAt DateTime @default(now())

  @@unique([botInstanceId, skillPackId])
  @@index([botInstanceId])
  @@index([skillPackId])
}

// ============================================
// COMMUNICATION CHANNELS
// Configure and monitor messaging channels per bot
// ============================================

model CommunicationChannel {
  id          String   @id @default(cuid())
  name        String   // e.g., "Support Slack", "Alerts Telegram"
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  type String

  // Channel configuration (type-specific)
  // Slack: { token: string, channelId?: string }
  // Telegram: { botToken: string, chatId?: string }
  // Discord: { botToken: string, guildId?: string, channelId?: string }
  // Email: { smtpHost, smtpPort, username, password, fromAddress }
  // Webhook: { url, headers?, secret? }
  config String

  // Default settings for this channel
  defaults String @default("{}")
  // e.g., { mentionOnError: true, quietHours: { start: "22:00", end: "08:00" } }

  // Status tracking
  status        String @default("PENDING")
  statusMessage String?
  lastTestedAt  DateTime?
  lastError     String?
  errorCount    Int @default(0)

  // Health metrics
  messagesSent     Int @default(0)
  messagesFailed   Int @default(0)
  lastMessageAt    DateTime?
  lastActivityAt   DateTime?

  // Sharing
  isShared Boolean @default(true)  // Can be used by multiple bots

  tags String @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  botBindings BotChannelBinding[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([type])
  @@index([status])
}

// Binding between Bot and CommunicationChannel
model BotChannelBinding {
  id        String @id @default(cuid())
  botId     String
  bot       BotInstance @relation(fields: [botId], references: [id], onDelete: Cascade)
  channelId String
  channel   CommunicationChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // Purpose: notifications, alerts, user-messages, logs, etc.
  purpose String @default("notifications")

  // Bot-specific overrides (merged with channel defaults)
  settings String @default("{}")
  // e.g., {
  //   filters: [{ type: "error", minSeverity: "high" }],
  //   formatting: "markdown",
  //   mentionUsers: ["@admin"],
  //   includeMetadata: true
  // }

  // Target destination (overrides channel default)
  // Slack: specific channel ID
  // Telegram: specific chat ID
  // Email: specific recipients
  targetDestination String?

  // Status
  isActive Boolean @default(true)
  healthStatus String @default("UNKNOWN") // HEALTHY, UNHEALTHY, UNKNOWN
  lastHealthCheck DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([botId, channelId, purpose])
  @@index([botId])
  @@index([channelId])
  @@index([purpose])
}

// ============================================
// OPENCLAW-NATIVE ENUMS
// ============================================

// ============================================
// OPENCLAW-NATIVE MODELS
// ============================================

// GatewayConnection: Tracks the WebSocket connection to an OpenClaw gateway
model GatewayConnection {
  id         String      @id @default(cuid())
  instanceId String      @unique
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  host     String @default("localhost")
  port     Int    @default(18789)
  authMode String @default("token") // "token" | "password"
  authToken String? // Encrypted gateway auth token

  status        String @default("DISCONNECTED")
  lastHeartbeat DateTime?
  configHash    String?
  latencyMs     Int?

  protocolVersion Int?
  clientMetadata  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

// OpenClawProfile: Local profile configuration for a bot instance
model OpenClawProfile {
  id         String      @id @default(cuid())
  instanceId String      @unique
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  profileName String
  configPath  String // e.g., ~/.openclaw/profiles/<name>/openclaw.json
  stateDir    String // e.g., ~/.openclaw/profiles/<name>/state/
  workspace   String // e.g., ~/openclaw/<name>/
  basePort    Int    @default(18789)

  // Service management
  serviceName String? // e.g., bot.openclaw.<profile> or openclaw-gateway-<profile>.service
  serviceType String? // "launchd" | "systemd"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileName])
  @@index([instanceId])
}

// ChannelAuthSession: Tracks channel authentication/pairing flows
model ChannelAuthSession {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  channelType String
  state       String @default("PENDING")

  // Auth flow data
  qrCodeData  String? // Base64 QR code for WhatsApp
  authToken   String? // Bot token for Telegram/Discord
  pairingCode String? // Pairing code for WhatsApp

  // Timing
  expiresAt DateTime?
  pairedAt  DateTime?

  // Error tracking
  lastError    String?
  attemptCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([instanceId])
  @@index([state])
  @@index([channelType])
}

// DeploymentTarget: Reusable deployment target configuration
model DeploymentTarget {
  id   String         @id @default(cuid())
  name String
  type String

  // Type-specific configuration (JSON)
  // For docker: { imageName, networkName }
  // For ecs-ec2: { accessKeyId, secretAccessKey, region }
  // For gce: { projectId, zone }
  // For azure-vm: { subscriptionId, resourceGroup, region }
  config String @default("{}")

  status        String   @default("active") // "active" | "inactive" | "error"
  statusMessage String?
  lastCheckedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  instances BotInstance[]

  @@index([type])
  @@index([status])
}

// SecurityAuditResult: Security audit findings for a bot instance
model SecurityAuditResult {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Findings
  findings      String // Array of { ruleId, severity, message, field?, suggestedFix? }
  totalErrors   Int  @default(0)
  totalWarnings Int  @default(0)
  totalInfo     Int  @default(0)

  // Context
  configHash String?
  auditedAt  DateTime @default(now())
  auditedBy  String   @default("system")

  @@index([instanceId])
  @@index([auditedAt])
}

// ============================================
// PHASE 2: SLOs, BUDGETS, COSTS, ALERTS
// ============================================

// SloDefinition: Per-bot SLO targets
model SloDefinition {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  name        String
  description String?

  metric      String
  targetValue Float       // e.g., 99.9 for uptime %, or 200 for latency ms
  window      String

  // Current state
  currentValue Float?
  isBreached   Boolean  @default(false)
  breachedAt   DateTime?
  breachCount  Int      @default(0)

  // Evaluation
  lastEvaluatedAt DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@unique([instanceId, name])
  @@index([instanceId])
  @@index([metric])
  @@index([isBreached])
  @@index([isActive])
}

// BudgetConfig: Per-bot or per-fleet monthly cost limits
model BudgetConfig {
  id String @id @default(cuid())

  // Scope: either bot-level or fleet-level (exactly one must be set)
  instanceId String?
  instance   BotInstance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  fleetId    String?
  fleet      Fleet?       @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Budget settings
  monthlyLimitCents Int // Monthly budget in cents (e.g., 10000 = $100.00)
  currency          String @default("USD")

  // Alert thresholds (percentages of monthly limit)
  warnThresholdPct     Int @default(75)  // Alert at 75% of budget
  criticalThresholdPct Int @default(90)  // Critical alert at 90%

  // Current state
  currentSpendCents Int      @default(0)
  periodStart       DateTime @default(now())
  periodEnd         DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([instanceId])
  @@index([fleetId])
  @@index([isActive])
}
// CostEvent: Individual token usage / cost events
model CostEvent {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Provider info
  provider String
  model    String       // e.g., "gpt-4", "claude-3-opus"

  // Token usage
  inputTokens  Int @default(0)
  outputTokens Int @default(0)

  // Cost
  costCents Int // Cost in cents

  // Context
  channelType String? // Which channel triggered this
  traceId     String? // Optional link to a trace

  // Metadata
  metadata String @default("{}")

  occurredAt DateTime @default(now())

  @@index([instanceId])
  @@index([provider])
  @@index([occurredAt])
  @@index([instanceId, occurredAt])
}

// HealthAlert: Persistent, DB-backed alerts with remediation
model HealthAlert {
  id String @id @default(cuid())

  // Scope: bot-level or fleet-level
  instanceId String?
  instance   BotInstance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  fleetId    String?
  fleet      Fleet?       @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  // Alert info
  rule     String         // e.g., "unreachable_instance", "slo_breach", "budget_warning"
  severity String
  status   String    @default("ACTIVE")

  title   String
  message String
  detail  String?

  // Remediation
  remediationAction String? // "restart", "reconcile", "re-pair-channel", "run-doctor"
  remediationNote   String?

  // Timing
  firstTriggeredAt DateTime @default(now())
  lastTriggeredAt  DateTime @default(now())
  resolvedAt       DateTime?
  acknowledgedAt   DateTime?
  acknowledgedBy   String?

  // Tracking
  consecutiveHits Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([instanceId])
  @@index([fleetId])
  @@index([rule])
  @@index([severity])
  @@index([status])
  @@index([firstTriggeredAt])
}

// HealthSnapshot: Point-in-time health data from a bot's gateway
model HealthSnapshot {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Health data from Gateway
  data      String    // Full health snapshot from Gateway WS
  isHealthy Boolean @default(true)

  // Channel health
  channelsLinked   Int @default(0)
  channelsDegraded Int @default(0)

  // Performance
  gatewayLatencyMs Int?

  capturedAt DateTime @default(now())

  @@index([instanceId])
  @@index([capturedAt])
  @@index([isHealthy])
}

// AgentStateSnapshot: Periodic snapshot of agent live state from Gateway
model AgentStateSnapshot {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Live state captured from Gateway
  liveConfig      String
  liveConfigHash  String
  liveSkills      String    @default("[]")
  liveMcpServers  String    @default("[]")
  liveChannels    String    @default("[]")
  liveToolProfile String?

  // Pre-computed diff against deployed config
  diffFromDeployed String?
  hasEvolved       Boolean @default(false)
  totalChanges     Int     @default(0)

  // Gateway state at capture time
  gatewayReachable Boolean @default(true)

  capturedAt DateTime @default(now())

  @@index([instanceId])
  @@index([instanceId, capturedAt])
}

// DevicePairing: Tracks device pairing requests and approvals for DM access control
model DevicePairing {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  channelType  String
  senderId     String
  senderName   String?
  platform     String?

  state        String @default("PENDING")
  pairingCode  String?
  expiresAt    DateTime?

  approvedAt   DateTime?
  revokedAt    DateTime?
  lastSeenAt   DateTime?

  ipAddress    String?
  deviceInfo   String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([instanceId])
  @@index([state])
  @@index([channelType])
  @@index([instanceId, pairingCode])
  @@unique([instanceId, channelType, senderId])
}

// ============================================
// NOTIFICATION CHANNELS & ALERT ROUTING
// ============================================

// NotificationChannel: External notification destinations (Slack webhook, generic webhook, email)
model NotificationChannel {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  name    String
  type    String // SLACK_WEBHOOK, WEBHOOK, EMAIL

  // Type-specific config (JSON)
  // SLACK_WEBHOOK: { url: string }
  // WEBHOOK: { url: string, headers?: Record<string, string>, secret?: string }
  // EMAIL: { addresses: string[], smtpConfig?: {...} }
  config  String

  enabled Boolean @default(true)

  // Status tracking
  lastTestedAt   DateTime?
  lastDeliveryAt DateTime?
  lastError      String?
  deliveryCount  Int @default(0)
  failureCount   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  notificationRules AlertNotificationRule[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([type])
  @@index([enabled])
}

// AlertNotificationRule: Links alert severity/types to notification channels
model AlertNotificationRule {
  id        String              @id @default(cuid())
  channelId String
  channel   NotificationChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // Filter criteria (all optional â€” if unset, matches all)
  severities String? // JSON array, e.g. ["CRITICAL","ERROR"]
  alertRules String? // JSON array, e.g. ["token_spike","budget_critical"]

  enabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId])
  @@index([enabled])
}

// AlertRuleConfig: Per-workspace alert rule configuration
model AlertRuleConfig {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  rule       String  // e.g. "token_spike", "budget_critical"
  enabled    Boolean @default(true)
  severity   String  // e.g. "CRITICAL", "ERROR", "WARNING", "INFO"
  thresholds String? // JSON string with threshold values

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, rule], name: "workspaceId_rule")
  @@index([workspaceId])
  @@index([rule])
}

// ============================================
// BOT-TO-BOT ROUTING / DELEGATION
// ============================================

// BotRoutingRule: Defines when one bot should delegate to another
model BotRoutingRule {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  sourceBotId String
  sourceBot   BotInstance @relation("SourceBot", fields: [sourceBotId], references: [id], onDelete: Cascade)

  targetBotId String
  targetBot   BotInstance @relation("TargetBot", fields: [targetBotId], references: [id], onDelete: Cascade)

  // Matching criteria
  triggerPattern String  // Regex or keyword match
  description    String  // Human-readable, e.g. "infrastructure questions"

  priority Int     @default(0)
  enabled  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@index([sourceBotId])
  @@index([targetBotId])
  @@index([enabled])
}

// A2A API Key for bot-to-bot authentication
model A2aApiKey {
  id            String    @id @default(cuid())
  keyHash       String    // SHA-256 hash of the full key
  keyPrefix     String    // First 12 chars for display (e.g., "mh_a2a_7f8a...")
  label         String?
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  lastUsedAt    DateTime?
  expiresAt     DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())

  @@index([botInstanceId])
  @@index([keyHash])
}

// Bot team member: defines delegation relationships between bots
model BotTeamMember {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // The bot that can delegate (the "team lead")
  ownerBotId  String
  ownerBot    BotInstance @relation("TeamOwner", fields: [ownerBotId], references: [id], onDelete: Cascade)

  // The bot that receives delegated tasks (the "team member")
  memberBotId String
  memberBot   BotInstance @relation("TeamMember", fields: [memberBotId], references: [id], onDelete: Cascade)

  // What this team member does
  role        String    // e.g. "Marketing Expert", "DevOps Engineer"
  description String    // e.g. "Handles marketing strategy, content creation, campaigns"

  enabled     Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([ownerBotId, memberBotId])
  @@index([ownerBotId])
  @@index([memberBotId])
}
